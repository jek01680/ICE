<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.mybatis.mapper.oracle.resource">


	<!-- 자원관리 -->

	<select id="selectResManage" parameterType="ResManageSearchVO" resultType="resManageVo">
	select * from(
		select rownum as RNUM, A.*
		from (
		   	select * from v_resmanage
		    order by resname
		)A
	)
	<![CDATA[ 
	where RNUM > #{firstRecordIndex}
	 and RNUM <= #{firstRecordIndex } + #{recordCountPerPage}]]>
	</select>
	
	<select resultType="int" id="selectTotalRecord">
		select count(*) from v_resmanage 
	</select>
	
	<select id="selectResKind" resultType="resKindVo">
		select * from resKind
	</select>

	
	<insert id="insertResManage" parameterType="resManagevo">

	insert into resmanage(resno, resname, resimage, ressize, reslocation, resoriginalimage, rkNo, ressubdesc)
	values(resno_seq.nextval, #{resName}, #{resImage}, #{resSize}, #{resLocation}, #{resOriginalImage}, #{rkNo}, #{resSubdesc})

	</insert>
	<select id="selectResManageOne" parameterType="int" resultType="resManageVo">
		select * from v_resManage 
		where resNo=#{resNo}
	</select>
	<update id="updateResource" parameterType="resManageVo">
		update resmanage
		set resname=#{resName}
		<if test="resImage!=null and resImage!=''">
		, resimage=#{resImage}, ressize=#{resSize}, resoriginalimage=#{resOriginalImage}
		</if>
		, reslocation=#{resLocation}, ressubdesc=#{resSubdesc}, rkNo=#{rkNo}
		where resno=#{resNo}
	</update>
	<delete parameterType="int" id="deleteResManage">
		delete from resmanage where resNo=#{resNo} 
	</delete>
	
	<!-- 자원예약 -->
	<select id="selectReserveResNo" parameterType="int" resultType="resReserveVo">
		select * from v_resreserve
		where resno=#{resNo}
	</select>
	<select id="selectReserveKind" parameterType="int" resultType="resKindVo">
		select * from reskind
		where rkno=#{rkNo}
	</select>
	<select id="selectStartAvailableHour" parameterType="resReserveVo" resultType="resReserveVo">
		select * from (
		    select * from v_resreserve
		    where <![CDATA[ (rvend >to_date(#{pickDate}, 'YYYY-MM-DD')]]>
		    and <![CDATA[ rvend < to_date(#{pickDate}, 'YYYY-MM-DD')+1)]]>
		    or <![CDATA[ (rvstart > to_date(#{pickDate}, 'YYYY-MM-DD')]]>
		    and <![CDATA[ rvstart < to_date(#{pickDate}, 'YYYY-MM-DD')+1)]]>
		    or <![CDATA[ (rvstart <= to_date(#{pickDate}, 'YYYY-MM-DD')]]>
		    and <![CDATA[ rvend >= to_date(#{pickDate}, 'YYYY-MM-DD')+1)]]>
		)
		where resno=#{resNo}
		order by rvstart
	</select>
	<select id="selectEndAvailableHour" parameterType="resReserveVo" resultType="resReserveVo">
	select A.* from(
   	 	select rvno, resno, rvstart from v_resreserve
    	where resNo=#{resNo}
    	and rvstart > to_date(#{pickDate}, 'YYYY-MM-DD hh24:Mi')
    	order by rvstart)A
	where rownum = 1
	</select>
	
	<insert id="insertResReserve">
		insert into resreserve(rvno, resno, rvstart, rvend, rvReason, memno)
		values(rvno_seq.nextval, 1, #{rvStart},#{rvEnd}, #{rvReason}, #{memNo})
	</insert>
	
	<!-- 자원예약 처리 -->
	<select id="selectReserve" parameterType="resReserveSearchVo" resultType="resReserveVo">
	select * from(
		select rownum as RNUM, A.*
		from (
		   	select * from v_resreserve
			where rvconfirm='w'
		)A
	)
	<![CDATA[ 
	where RNUM > #{firstRecordIndex}
	 and RNUM <= #{firstRecordIndex } + #{recordCountPerPage}]]>
	</select>
	<select id="selectReserveCount" resultType="int">
		select count(*) from v_resreserve
		where rvconfirm='w'
	</select>
	<update id="updateConfirmReserve" parameterType="resKindVo">
	update resreserve
	set rvconfirm=#{rkKind}
	where rvNo=#{rkNo}
	</update>
	<update id="updateNoReasonReserve" parameterType="resKindVo">
	update resreserve
	set rvReReason=#{rkKind}
	where rvNo=#{rkNo}
	</update>
</mapper>